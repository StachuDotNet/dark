// aliases and helpers

type Json = Stdlib.AltJson.Json

type ParseError = Stdlib.AltJson.ParseError.ParseError

// TODO: backfill a _lot_ from json.dark

// TODO: think - should it be impossible for a JNumber to hold anything that isn't alowed by JSON
// what about huge strings or something? look into the limitations of JSON per the spec

// TODO: `format` doesn't _have_ to be a builtin... but `parse` kinda does, for now
// should we bother taking the formatter out of Builtin land? enh

// <helpers>
let parse (jsonString: String) : Stdlib.Result.Result<Json, ParseError> =
  Stdlib.AltJson.parse jsonString

let format (json: Json) : String = Stdlib.AltJson.format json


let parsedOk (json: Json) : Stdlib.Result.Result<Json, ParseError> =
  Stdlib.Result.Result.Ok json

let parseError (err: ParseError) : Stdlib.Result.Result<Json, ParseError> =
  Stdlib.Result.Result.Error err
// </helpers>

// tests
module Null =
  format Json.Null = "null"
  parse "null" = parsedOk Json.Null

  parse "NULL" = parseError ParseError.NotJson
  parse "Null" = parseError ParseError.NotJson
  parse "unit" = parseError ParseError.NotJson
  parse "()" = parseError ParseError.NotJson
  parse "" = parseError ParseError.NotJson


module Bool =
  format (Json.Bool true) = "true"
  format (Json.Bool false) = "false"
  parse "true" = parsedOk (Json.Bool true)
  parse "false" = parsedOk (Json.Bool false)

  parse "False" = parseError ParseError.NotJson
  parse "f" = parseError ParseError.NotJson
  parse "True" = parseError ParseError.NotJson
  parse "t" = parseError ParseError.NotJson


module Number =
  format (Json.Number 0.0) = "0"
  parse "0" = parsedOk (Json.Number 0.0)

  format (Json.Number 0.1) = "0.1"
  parse "0.1" = parsedOk (Json.Number 0.1)

  format (Json.Number -1.0) = "-1"
  parse "-1" = parsedOk (Json.Number -1.0)

  format (Json.Number -1337.0) = "-1337"
  parse "-1337" = parsedOk (Json.Number -1337.0)

  // scientific notation
  parse "1.5e2" = parsedOk (Json.Number 150.0)
  parse "1.5E2" = parsedOk (Json.Number 150.0)
  parse "1.5e+2" = parsedOk (Json.Number 150.0)
  parse "1.5e-2" = parsedOk (Json.Number 0.015)

  // large numbers
  parse "999999999999.0" = parsedOk (Json.Number 999999999999.0)
  parse "-999999999999.0" = parsedOk (Json.Number -999999999999.0)

  // decimals
  parse "3.14159" = parsedOk (Json.Number 3.14159)
  parse "0.0001" = parsedOk (Json.Number 0.0001)

  // leading zeros not allowed
  parse "01" = parseError ParseError.NotJson
  parse "00.1" = parseError ParseError.NotJson



module String =
  format (Json.String "hi") = "\"hi\""
  parse "\"hi\"" = parsedOk (Json.String "hi")

  parse "hi" = parseError ParseError.NotJson
  parse "\'hi\'" = parseError ParseError.NotJson

  // strings with escaped quotes
  parse "\"hello \\\"world\\\"\"" = parsedOk (Json.String "hello \"world\"")
  format (Json.String "hello \"world\"") = "\"hello \\\"world\\\"\""

  // strings with other escape sequences
  parse "\"line1\\nline2\"" = parsedOk (Json.String "line1\nline2")
  parse "\"tab\\there\"" = parsedOk (Json.String "tab\there")
  parse "\"back\\\\slash\"" = parsedOk (Json.String "back\\slash")
  parse "\"forward\\/slash\"" = parsedOk (Json.String "forward/slash")

  // empty string
  format (Json.String "") = "\"\""
  parse "\"\"" = parsedOk (Json.String "")

  // unicode characters
  parse "\"hello ä¸–ç•Œ\"" = parsedOk (Json.String "hello ä¸–ç•Œ")
  parse "\"emoji ðŸŽ‰\"" = parsedOk (Json.String "emoji ðŸŽ‰")


module Array =
  // empty
  format (Json.Array []) = "[]"
  parse "[]" = parsedOk (Json.Array [])

  // simple single null
  format (Json.Array [ Json.Null ]) = "[null]"
  parse "[ null ]" = parsedOk (Json.Array [ Json.Null ])

  // first fibonnaci numbers
  format (
    Json.Array
      [ Json.Number 0.0
        Json.Number 1.0
        Json.Number 1.0
        Json.Number 2.0
        Json.Number 3.0
        Json.Number 5.0
        Json.Number 8.0
        Json.Number 13.0
        Json.Number 21.0
        Json.Number 34.0 ]
  ) = "[0,1,1,2,3,5,8,13,21,34]"

  parse "[0, 1, 1, 2, 3, 5, 8, 13, 21, 34]" = parsedOk (
    Json.Array
      [ Json.Number 0.0
        Json.Number 1.0
        Json.Number 1.0
        Json.Number 2.0
        Json.Number 3.0
        Json.Number 5.0
        Json.Number 8.0
        Json.Number 13.0
        Json.Number 21.0
        Json.Number 34.0 ]
  )

  // nested arrays
  parse
    """
      [ [1, 2, 3],
        [4, 5, 6],
        [7, 8, 9] ]""" = parsedOk (
    Json.Array
      [ Json.Array [ Json.Number 1.0; Json.Number 2.0; Json.Number 3.0 ]
        Json.Array [ Json.Number 4.0; Json.Number 5.0; Json.Number 6.0 ]
        Json.Array [ Json.Number 7.0; Json.Number 8.0; Json.Number 9.0 ] ]
  )

  format (
    Json.Array
      [ Json.Array [ Json.Number 1.0; Json.Number 2.0; Json.Number 3.0 ]
        Json.Array [ Json.Number 4.0; Json.Number 5.0; Json.Number 6.0 ]
        Json.Array [ Json.Number 7.0; Json.Number 8.0; Json.Number 9.0 ] ]
  ) = "[[1,2,3],[4,5,6],[7,8,9]]"


  // mixed types
  format (Json.Array [ Json.Null; Json.Number 1.2 ]) = "[null,1.2]"

  parse "[ null, 1.2 ]" = parsedOk (Json.Array [ Json.Null; Json.Number 1.2 ])

  // arrays with all types mixed
  parse """[null, true, false, 1, "str", [], {}]""" = parsedOk (
    Json.Array
      [ Json.Null
        Json.Bool true
        Json.Bool false
        Json.Number 1.0
        Json.String "str"
        Json.Array []
        Json.Object [] ]
  )



module Object =
  // blank
  format (Json.Object []) = """{}"""
  parse """{}""" = parsedOk (Json.Object [])


  // single name
  format (Json.Object [ ("n", Json.Null) ]) = """{"n":null}"""

  parse """{ "n": null }""" = parsedOk (Json.Object[("n", Json.Null)])


  // dupe name
  parse """{ "n": null, "n": 1 }""" = parsedOk (
    Json.Object [ ("n", Json.Null); ("n", Json.Number 1.0) ]
  )

  format (Json.Object [ ("n", Json.Null); ("n", Json.Number 1.0) ]) = """{"n":null,"n":1}"""


  // blank name
  format (Json.Object [ ("", Json.Null) ]) = """{"":null}"""

  parse """{ "": null }""" = parsedOk (Json.Object[("", Json.Null)])

  // multiple fields
  parse """{"name": "John", "age": 30, "active": true}""" = parsedOk (
    Json.Object
      [ ("name", Json.String "John")
        ("age", Json.Number 30.0)
        ("active", Json.Bool true) ]
  )

  // nested objects
  parse """{"user": {"name": "Jane", "id": 1}}""" = parsedOk (
    Json.Object
      [ ("user",
         Json.Object [ ("name", Json.String "Jane"); ("id", Json.Number 1.0) ]) ]
  )

  // object with array
  parse """{"items": [1, 2, 3]}""" = parsedOk (
    Json.Object
      [ ("items",
         Json.Array [ Json.Number 1.0; Json.Number 2.0; Json.Number 3.0 ]) ]
  )

module Errors =
  // names must be strings
  parse """{ 1: 1}""" = parseError ParseError.NotJson

  parse """{ null: 1}""" = parseError ParseError.NotJson

  // names must be in quotes
  parse """{ invalidName: 1}""" = parseError ParseError.NotJson

  // ..._double_ quotes
  parse """{ 'invalidName': 1}""" = parseError ParseError.NotJson